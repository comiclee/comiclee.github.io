<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>java工程的overlay部署模式</title>
  <meta name="description" content="  前端模块化后，一个模块可以在多个页面或者一个页面的多处被复用，提升了我们的开发效率，避免重复造轮子。而后，我们对复用性有了更高的要求，能不能让一个模块在多个工程（网站）间复用呢？我们的几个网站大多情况下使用的是同一套UI，我们希望尽量避免把相同的代码从这个网站拷贝到另一个网站，而是使其成为更加公共的模块，能够...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://blog.comiclee.com/2014/12/java%e7%9a%84overlay%e6%a8%a1%e5%bc%8f">
  <link rel="alternate" type="application/rss+xml" title="前端栗仔 | Thinking in Front-end" href="http://blog.comiclee.com/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">前端栗仔 | Thinking in Front-end</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/about/">关于我</a>
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">java工程的overlay部署模式</h1>
    <p class="post-meta">Dec 24, 2014 • comiclee</p>
  </header>

  <article class="post-content">
    <p id="id-前端模块在java工程间的复用-背景" style="color: #333333;">
  前端模块化后，一个模块可以在多个页面或者一个页面的多处被复用，提升了我们的开发效率，避免重复造轮子。而后，我们对复用性有了更高的要求，能不能让一个模块在多个工程（网站）间复用呢？我们的几个网站大多情况下使用的是同一套UI，我们希望尽量避免把相同的代码从这个网站拷贝到另一个网站，而是使其成为更加公共的模块，能够在不同的网站间复用。
</p>

<p style="color: #333333;">
  maven的overlay模式能够将一个外部的war包部署到当前war包中，包括静态文件和class，最后的效果就是将两个war包合并起来了。例如我们的主模块使用了一个公共模块fe_common，按照如下方式配置overlay模式：
</p>

<!--more-->

<ol>
  <li>在主模块的pom文件里加上依赖项 将依赖的模块加入dependency节点，并指明type值为war</li>
</ol>

<pre>&lt;dependency&gt;
   &lt;groupId&gt;com.company&lt;/groupId&gt;
   &lt;artifactId&gt;fe_common&lt;/artifactId&gt;
   &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
   &lt;type&gt;war&lt;/type&gt;
 &lt;/dependency&gt;</pre>

<p style="color: #333333;">
  2. 添加一个plugin——maven-war-plugin，并在overlay中设置依赖的模块，以及包含的文件
</p>

<pre style="color: #333333;">&lt;plugin&gt;
   &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
   &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
   &lt;version&gt;2.1.1&lt;/version&gt;
   &lt;configuration&gt;
     &lt;dependentWarIncludes&gt;WEB-INF/**/*,static/**/*&lt;/dependentWarIncludes&gt;
     &lt;overlays&gt;
       &lt;overlay&gt;
         &lt;groupId&gt;com.company&lt;/groupId&gt;
         &lt;artifactId&gt;fe_common&lt;/artifactId&gt;
       &lt;/overlay&gt;
     &lt;/overlays&gt;
   &lt;/configuration&gt;
 &lt;/plugin&gt;</pre>

<p style="color: #333333;">
  经过这两步就设置好了，在编译的时候，主模块会自动下载fe_common模块的war包，在打包阶段将两个war包合并一块儿打包。
</p>

<h1 id="id-前端模块在java工程间的复用-注意和说明" style="color: #333333;">
  注意和说明
</h1>

<p style="color: #333333;">
  1. 由于overlay模式是将依赖包的文件合并到当前包中，所以要避免文件冲突，最好把依赖包的文件放在一个特定的目录中，如主模块的目录结构是/static/css , /static/js , /WEB-INF/views ，而fe_common的目录结构是/static/css/fe_common ,  /static/js/fe_common , /WEB-INF/views/fe_common。由于在本地开发的时候，IDE或者maven会在源代码处添加一些临时目录，而且不会删掉，所以应在.gitignore文件中添加上排除的目录
</p>

<pre class="lang:sh decode:true">overlays
src/main/webapp/**/fe_common</pre>

<p style="color: #333333;">
  2. overlay形式的依赖能够正确的编译打包和部署，如上所述，最后两个模块会合并到一个包里。如果是在本地调试阶段，不少IDE能够正确识别overlay的模块并引入依赖。但如果是用普通编辑器+命令行编译，则更改了fe_common后应该mvn install一下，这样对主模块执行mvn compile时才能正确取到包
</p>

<p style="color: #333333;">
  3. 以nested方式运行jetty(mvn jetty:run)也可以识别出overlay模块，不过需要比较新的jetty plugin（最好升级到最新），但这种方式仍然不支持include ftl文件，猜测这和freemarker编译器的处理行为有关。解决方法是在maven的test-compile阶段把依赖的模块的ftl文件拷到本地，以使其正常运行。当然，这些拷过来的文件也不会被删掉，只要按照第1点所说的，在.gitignore文件中添加排除项就不会被加入到版本库中。
</p>

<pre class="lang:xhtml decode:true">&lt;plugin&gt;
  &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
  &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
  &lt;version&gt;2.10&lt;/version&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;id&gt;unpack&lt;/id&gt;
      &lt;phase&gt;test-compile&lt;/phase&gt;
      &lt;goals&gt;
        &lt;goal&gt;unpack&lt;/goal&gt;
      &lt;/goals&gt;
      &lt;configuration&gt;
        &lt;artifactItems&gt;
          &lt;artifactItem&gt;
            &lt;groupId&gt;com.company&lt;/groupId&gt;
            &lt;artifactId&gt;fe_common&lt;/artifactId&gt;
            &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
            &lt;type&gt;war&lt;/type&gt;
            &lt;overWrite&gt;true&lt;/overWrite&gt;
            &lt;outputDirectory&gt;${basedir}/src/main/webapp&lt;/outputDirectory&gt;
            &lt;includes&gt;WEB-INF/views/**/*&lt;/includes&gt;
          &lt;/artifactItem&gt;
        &lt;/artifactItems&gt;
      &lt;/configuration&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;</pre>

<p>本文短地址： <a href="http://blog.comiclee.com/?p=47">http://blog.comiclee.com/?p=47</a></p>

<p>参考资料</p>

<p style="color: #333333;">
  <span style="color: #042eee;"><span style="text-decoration: underline;"><a class="external-link" style="color: #3b73af;" href="http://maven.apache.org/plugins/maven-war-plugin/overlays.html" target="_blank" rel="nofollow">http://maven.apache.org/plugins/maven-war-plugin/overlays.html</a></span></span> <span style="color: #042eee;"><span style="text-decoration: underline;"><a class="external-link" style="color: #3b73af;" href="http://eclipse.org/jetty/documentation/current/jetty-maven-plugin.html#using-overlaid-wars" target="_blank" rel="nofollow">http://eclipse.org/jetty/documentation/current/jetty-maven-plugin.html#using-overlaid-wars</a></span></span>
</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">前端栗仔 | Thinking in Front-end</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>前端栗仔 | Thinking in Front-end</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Thinking in Front-end</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
